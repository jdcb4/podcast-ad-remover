{% extends "base.html" %}

{% block content %}
<div class="mb-6">
    <a href="/" class="text-blue-600 hover:underline">&larr; Back to Subscriptions</a>
</div>

<div class="bg-white p-6 rounded-lg shadow-md mb-6">
    <div class="flex gap-6 items-start flex-col md:flex-row">
        {% if subscription.image_url %}
        <img src="{{ subscription.image_url }}" alt="{{ subscription.title }}"
            class="w-32 h-32 object-cover rounded-lg shadow-sm">
        {% endif %}
        <div class="flex-1 w-full">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-4">
                <h2 class="text-2xl font-bold">{{ subscription.title }}</h2>
                <div class="flex gap-2 w-full md:w-auto">
                    <a href="/feeds/{{ subscription.slug }}.xml" target="_blank"
                        class="bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600 text-center flex-1 md:flex-none">
                        RSS Feed
                    </a>
                    <button onclick="checkNow({{ subscription.id }})"
                        class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 flex-1 md:flex-none">
                        Check for Updates
                    </button>
                </div>
            </div>
            <p class="text-gray-600 break-all">{{ subscription.feed_url }}</p>

            <div class="mt-4 flex flex-wrap gap-2">
                <a href="{{ links.rss }}" class="text-xs bg-orange-500 text-white px-2 py-1 rounded hover:bg-orange-600"
                    target="_blank">RSS</a>
                <a href="{{ links.pocket_casts }}"
                    class="text-xs bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600">Pocket Casts</a>
                <a href="{{ links.apple }}"
                    class="text-xs bg-purple-600 text-white px-2 py-1 rounded hover:bg-purple-700">Apple</a>
                <a href="{{ links.overcast }}"
                    class="text-xs bg-orange-600 text-white px-2 py-1 rounded hover:bg-orange-700">Overcast</a>
                <a href="{{ links.castbox }}"
                    class="text-xs bg-orange-400 text-white px-2 py-1 rounded hover:bg-orange-500">Castbox</a>
                <a href="{{ links.podcast_addict }}"
                    class="text-xs bg-teal-600 text-white px-2 py-1 rounded hover:bg-teal-700">Addict</a>
            </div>
        </div>
        <div class="mt-4 md:mt-0">
            <button onclick="deleteSubscription({{ subscription.id }})"
                class="text-red-600 hover:text-red-800 text-sm border border-red-200 hover:border-red-400 px-3 py-1 rounded">
                Delete Subscription
            </button>
        </div>
    </div>
</div>
</div>

<div class="bg-white p-6 rounded-lg shadow-md mb-6">
    <div class="flex justify-between items-center mb-4 cursor-pointer"
        onclick="document.getElementById('settings-form').classList.toggle('hidden')">
        <h3 class="text-xl font-bold">Processing Settings</h3>
        <span class="text-gray-500 text-sm hover:text-gray-700">Toggle</span>
    </div>

    <form id="settings-form" action="/subscriptions/{{ subscription.id }}/settings" method="POST" class="hidden">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="space-y-4">
                <h4 class="font-semibold text-gray-700">Content Removal</h4>
                <div class="flex items-center">
                    <input type="checkbox" id="remove_ads" name="remove_ads" value="true" {% if subscription.remove_ads
                        %}checked{% endif %} class="h-4 w-4 text-blue-600 rounded">
                    <label for="remove_ads" class="ml-2 text-gray-700">Remove Ads</label>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="remove_promos" name="remove_promos" value="true" {% if
                        subscription.remove_promos %}checked{% endif %} class="h-4 w-4 text-blue-600 rounded">
                    <label for="remove_promos" class="ml-2 text-gray-700">Remove Promos</label>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="remove_intros" name="remove_intros" value="true" {% if
                        subscription.remove_intros %}checked{% endif %} class="h-4 w-4 text-blue-600 rounded">
                    <label for="remove_intros" class="ml-2 text-gray-700">Remove Intros</label>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="remove_outros" name="remove_outros" value="true" {% if
                        subscription.remove_outros %}checked{% endif %} class="h-4 w-4 text-blue-600 rounded">
                    <label for="remove_outros" class="ml-2 text-gray-700">Remove Outros</label>
                </div>
            </div>

            <div class="space-y-4">
                <h4 class="font-semibold text-gray-700">Features</h4>
                <div class="flex items-center">
                    <input type="checkbox" id="append_summary" name="append_summary" value="true" {% if
                        subscription.append_summary %}checked{% endif %} class="h-4 w-4 text-blue-600 rounded">
                    <label for="append_summary" class="ml-2 text-gray-700">Generate & Append Summaries (AI)</label>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="append_title_intro" name="append_title_intro" value="true" {% if
                        subscription.append_title_intro %}checked{% endif %} class="h-4 w-4 text-blue-600 rounded">
                    <label for="append_title_intro" class="ml-2 text-gray-700">Append Title Intro (Standard)</label>
                </div>

                <div class="mt-4">
                    <label for="custom_instructions" class="block text-sm font-medium text-gray-700">Custom Ad Detection
                        Instructions</label>
                    <textarea id="custom_instructions" name="custom_instructions" rows="3"
                        placeholder="E.g., 'Remove segments discussing XYZ', 'Keep promos for host's other shows'"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2 border">{{ subscription.custom_instructions or '' }}</textarea>
                </div>
            </div>
        </div>

        <div class="mt-6 flex justify-end">
            <button type="submit" class="bg-gray-900 text-white px-4 py-2 rounded hover:bg-gray-800">
                Save Settings
            </button>
        </div>
    </form>
</div>

<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
    {% for ep in episodes %}
    <div class="bg-white rounded-lg shadow-md flex flex-col">
        <div class="p-4 flex-1">
            <div class="flex justify-between items-start mb-2">
                <h3 class="font-bold text-lg text-gray-900 line-clamp-2" title="{{ ep.title }}">{{ ep.title }}</h3>
                <span class="text-xs text-gray-500 whitespace-nowrap ml-2">{{ ep.pub_date }}</span>
            </div>
            <p class="text-xs text-gray-400 mb-3 truncate">{{ ep.guid }}</p>

            <div class="flex flex-wrap gap-2 mb-2">
                <span class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded">
                    {{ format_duration(ep.duration) }}
                </span>

                {% if ep.status == 'completed' %}
                <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded font-semibold">Completed</span>
                {% elif ep.status == 'processing' %}
                <span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded font-semibold">Processing</span>
                {% elif ep.status == 'failed' %}
                <span class="text-xs bg-red-100 text-red-800 px-2 py-1 rounded font-semibold"
                    title="{{ ep.error_message }}">Failed</span>
                {% else %}
                <span class="text-xs bg-gray-100 text-gray-800 px-2 py-1 rounded font-semibold">{{ ep.status }}</span>
                {% endif %}
            </div>

            {% if ep.description %}
            <p class="text-sm text-gray-600 mb-4 line-clamp-3" title="{{ ep.description }}">{{ ep.description }}</p>
            {% endif %}

            {% if ep.status == 'processing' %}
            <div class="mb-4">
                <div class="flex justify-between text-xs text-gray-500 mb-1">
                    <span>{{ ep.processing_step }}</span>
                    <span>{{ ep.progress }}%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div class="bg-blue-600 h-2 rounded-full transition-all duration-500"
                        style="width: {{ ep.progress }}%"></div>
                </div>
            </div>
            {% endif %}

            <div class="flex flex-wrap gap-3 text-sm text-blue-600">
                {% if ep.transcript_path %}
                <a href="../artifacts/transcript/{{ ep.id }}" target="_blank"
                    class="hover:underline flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                        </path>
                    </svg>
                    Transcript
                </a>
                {% endif %}
                {% if ep.ad_report_path %}
                <a href="../artifacts/report/{{ ep.id }}" target="_blank"
                    class="hover:underline flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                        </path>
                    </svg>
                    Report
                </a>
                {% endif %}
            </div>
        </div>

        <div class="bg-gray-50 px-4 py-3 border-t border-gray-100 flex justify-end gap-2">
            {% if ep.status == 'completed' %}
            <a href="/audio/{{ subscription.slug }}/{{ basename(ep.local_filename) }}" target="_blank"
                class="inline-flex items-center px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z">
                    </path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                Listen
            </a>
            {% endif %}

            {% if ep.status in ['processing', 'pending'] %}
            <button onclick="cancelEpisode({{ ep.id }})"
                class="inline-flex items-center px-3 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                Cancel
            </button>
            {% else %}
            <!-- Unified Reprocess Dropdown for Completed and Failed/Others -->
            <div class="relative inline-block text-left">
                <button type="button" onclick="toggleDropdown('menu-{{ ep.id }}')"
                    class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    Reprocess
                    <svg class="-mr-1 ml-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"
                        fill="currentColor" aria-hidden="true">
                        <path fill-rule="evenodd"
                            d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                            clip-rule="evenodd" />
                    </svg>
                </button>
                <div id="menu-{{ ep.id }}"
                    class="origin-top-right absolute right-0 bottom-full mb-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none hidden z-50">
                    <div class="py-1" role="menu">
                        <a href="#"
                            onclick="processEpisode({{ ep.id }}, false); toggleDropdown('menu-{{ ep.id }}'); return false;"
                            class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem">Full
                            Reprocess</a>
                        <a href="#"
                            onclick="processEpisode({{ ep.id }}, true); toggleDropdown('menu-{{ ep.id }}'); return false;"
                            class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem">Reprocess
                            (Skip Transcription)</a>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    {% else %}
    <div class="col-span-full text-center py-12 bg-white rounded-lg shadow text-gray-500">
        No episodes found.
    </div>
    {% endfor %}
</div>

<script>
    function toggleDropdown(id) {
        const el = document.getElementById(id);
        if (el.classList.contains('hidden')) {
            // Hide all others
            document.querySelectorAll('[id^=menu-]').forEach(x => x.classList.add('hidden'));
            el.classList.remove('hidden');
        } else {
            el.classList.add('hidden');
        }
    }

    // Close on click outside
    window.onclick = function (event) {
        // Check if the click target or any of its parents is a dropdown button or inside a dropdown menu
        let isDropdownButton = event.target.closest('.relative.inline-block.text-left > button');
        let isDropdownMenu = event.target.closest('[id^=menu-]');

        if (!isDropdownButton && !isDropdownMenu) {
            document.querySelectorAll('[id^=menu-]').forEach(x => x.classList.add('hidden'));
        }
    }

    async function checkNow(id) {
        if (!confirm('Check for new episodes now?')) return;
        await fetch(`/api/subscriptions/${id}/check`, { method: 'POST' });
        alert('Check triggered! Refresh in a moment.');
        location.reload();
    }

    async function processEpisode(id, skipTranscription) {
        const action = skipTranscription ? "Reprocess (Keep Transcript)" : "Process/Reprocess FULLY";
        if (!confirm(`${action}: Are you sure?`)) return;

        const url = `/api/episodes/${id}/process` + (skipTranscription ? "?skip_transcription=true" : "");
        await fetch(url, { method: 'POST' });
        alert('Processing triggered!');
        location.reload();
    }

    async function cancelEpisode(id) {
        if (!confirm('Cancel processing for this episode?')) return;
        await fetch(`/api/episodes/${id}/cancel`, { method: 'POST' });
        location.reload();
    }

    async function deleteSubscription(id) {
        if (!confirm('Are you sure you want to delete this subscription? All episodes and files will be removed.')) return;
        const res = await fetch(`/api/subscriptions/${id}`, { method: 'DELETE' });
        if (res.ok) {
            window.location.href = '/';
        } else {
            alert('Failed to delete subscription');
        }
    }
</script>
{% endblock %}