{% extends "base.html" %}

{% block content %}
<div class="mb-6">
    <a href="/" class="text-primary-400 hover:text-primary-300 transition-colors">&larr; Back to Subscriptions</a>
</div>

<div class="card mb-6">
    <div class="flex gap-6 sm:gap-8 items-start flex-col md:flex-row">
        {% if subscription.image_url %}
        <img src="{{ subscription.image_url }}" alt="{{ subscription.title }}"
            class="w-24 h-24 sm:w-32 sm:h-32 object-cover rounded-xl shadow-lg">
        {% endif %}
        <div class="flex-1 w-full">
            <div class="flex flex-col gap-2 mb-3">
                <h1 class="font-display text-3xl sm:text-4xl font-bold tracking-tight text-white leading-[1.1]">
                    {{ subscription.title }}
                </h1>
                {% if subscription.description %}
                <div class="text-sm text-text-secondary leading-relaxed max-w-3xl line-clamp-2">
                    {{ subscription.description | striptags }}
                </div>
                {% endif %}
                <div class="flex flex-wrap gap-2 mt-1">
                    <button onclick="checkNow({{ subscription.id }})" class="btn-primary btn-sm">Check Updates</button>
                    <button onclick="deleteSubscription({{ subscription.id }})"
                        class="btn-danger btn-sm">Delete</button>
                </div>
            </div>
        </div>
        <p class="text-text-muted break-all text-sm">{{ subscription.feed_url }}</p>
        {% if total_listens and total_listens > 0 %}
        <p class="text-sm text-text-secondary mt-2">
            <span class="font-semibold">Total Listens:</span> <span class="text-primary-400">{{ total_listens
                }}</span>
        </p>
        {% endif %}

        <div class="mt-6 flex flex-wrap gap-2">
            <a href="{{ links.direct }}" class="badge-soft">Direct</a>
            <a href="{{ links.pocket_casts }}" class="badge-soft">Pocket Casts</a>
            <a href="/subscribe/apple?url={{ links.apple | urlencode }}" class="badge-soft">Apple</a>
            <a href="{{ links.overcast }}" class="badge-soft">Overcast</a>
            <a href="{{ links.castbox }}" class="badge-soft">Castbox</a>
            <a href="{{ links.podcast_addict }}" class="badge-soft">Podcast Addict</a>
        </div>
    </div>
</div>
</div>

<div class="card mb-6">
    <div class="flex justify-between items-center mb-4 cursor-pointer"
        onclick="document.getElementById('settings-form').classList.toggle('hidden')">
        <h3 class="font-display text-xl font-bold">Processing Settings</h3>
        <span class="text-text-muted text-sm hover:text-text-secondary transition-colors">Toggle</span>
    </div>

    <form id="settings-form" action="/subscriptions/{{ subscription.id }}/settings" method="POST" class="hidden">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 md:gap-12">
            <div class="space-y-6">
                <h4 class="font-semibold border-b border-white/[0.08] pb-2">Content Removal</h4>
                <label class="flex items-center cursor-pointer">
                    <input type="checkbox" name="remove_ads" value="true" {% if subscription.remove_ads %}checked{%
                        endif %}
                        class="h-4 w-4 text-primary-500 rounded bg-surface-base border-white/20 focus:ring-primary-500">
                    <span class="ml-3">Remove Ads</span>
                </label>
                <label class="flex items-center cursor-pointer">
                    <input type="checkbox" name="remove_promos" value="true" {% if subscription.remove_promos
                        %}checked{% endif %}
                        class="h-4 w-4 text-primary-500 rounded bg-surface-base border-white/20 focus:ring-primary-500">
                    <span class="ml-3">Remove Promos</span>
                </label>
                <label class="flex items-center cursor-pointer">
                    <input type="checkbox" name="remove_intros" value="true" {% if subscription.remove_intros
                        %}checked{% endif %}
                        class="h-4 w-4 text-primary-500 rounded bg-surface-base border-white/20 focus:ring-primary-500">
                    <span class="ml-3">Remove Intros</span>
                </label>
                <label class="flex items-center cursor-pointer">
                    <input type="checkbox" name="remove_outros" value="true" {% if subscription.remove_outros
                        %}checked{% endif %}
                        class="h-4 w-4 text-primary-500 rounded bg-surface-base border-white/20 focus:ring-primary-500">
                    <span class="ml-3">Remove Outros</span>
                </label>

                <div class="pt-4 border-t border-white/[0.08]">
                    <h4 class="font-semibold mb-3">Retention Policy</h4>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm text-text-secondary mb-2">Auto-Downloads (Episodes to
                                Keep)</label>
                            <select name="retention_limit" class="select">
                                <option value="0" {% if subscription.retention_limit==0 %}selected{% endif %}>None
                                    (Manual Only)</option>
                                <option value="1" {% if (subscription.retention_limit is none or
                                    subscription.retention_limit==1) %}selected{% endif %}>Keep Latest 1 (Default)
                                </option>
                                <option value="2" {% if subscription.retention_limit==2 %}selected{% endif %}>Keep
                                    Latest 2</option>
                                <option value="3" {% if subscription.retention_limit==3 %}selected{% endif %}>Keep
                                    Latest 3</option>
                                <option value="5" {% if subscription.retention_limit==5 %}selected{% endif %}>Keep
                                    Latest 5</option>
                                <option value="10" {% if subscription.retention_limit==10 %}selected{% endif %}>Keep
                                    Latest 10</option>
                                <option value="20" {% if subscription.retention_limit==20 %}selected{% endif %}>Keep
                                    Latest 20</option>
                                <option value="1000" {% if subscription.retention_limit>=1000 %}selected{% endif %}>Keep
                                    All</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm text-text-secondary mb-2">Manual Downloads</label>
                            <select name="manual_retention_days" class="select">
                                <option value="7" {% if subscription.manual_retention_days==7 %}selected{% endif %}>Keep
                                    7 Days</option>
                                <option value="14" {% if (subscription.manual_retention_days or 14)==14 %}selected{%
                                    endif %}>Keep 14 Days</option>
                                <option value="30" {% if subscription.manual_retention_days==30 %}selected{% endif %}>
                                    Keep 30 Days</option>
                                <option value="90" {% if subscription.manual_retention_days==90 %}selected{% endif %}>
                                    Keep 90 Days</option>
                                <option value="365" {% if subscription.manual_retention_days==365 %}selected{% endif %}>
                                    Keep 1 Year</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="space-y-4">
                <h4 class="font-semibold border-b border-white/[0.08] pb-2">Features</h4>
                <label class="flex items-center cursor-pointer">
                    <input type="checkbox" name="ai_rewrite_description" value="true" {% if
                        subscription.ai_rewrite_description %}checked{% endif %}
                        class="h-4 w-4 text-primary-500 rounded bg-surface-base border-white/20 focus:ring-primary-500">
                    <span class="ml-3">Rewrite Description (AI Text)</span>
                </label>
                <label class="flex items-center cursor-pointer">
                    <input type="checkbox" name="ai_audio_summary" value="true" {% if subscription.ai_audio_summary
                        %}checked{% endif %}
                        class="h-4 w-4 text-primary-500 rounded bg-surface-base border-white/20 focus:ring-primary-500">
                    <span class="ml-3">Append Audio Summary (AI TTS)</span>
                </label>
                <label class="flex items-center cursor-pointer">
                    <input type="checkbox" name="append_title_intro" value="true" {% if subscription.append_title_intro
                        %}checked{% endif %}
                        class="h-4 w-4 text-primary-500 rounded bg-surface-base border-white/20 focus:ring-primary-500">
                    <span class="ml-3">Append Audio Title as Intro (TTS)</span>
                </label>

                <div class="mt-4">
                    <label class="block text-sm font-medium text-text-secondary mb-2">Custom Ad Detection
                        Instructions</label>
                    <textarea name="custom_instructions" rows="3" class="input font-mono text-sm"
                        placeholder="E.g., 'Remove segments discussing XYZ', 'Keep promos for host's other shows'">{{ subscription.custom_instructions or '' }}</textarea>
                </div>
            </div>
        </div>

        <div class="mt-6 flex justify-end pt-4 border-t border-white/[0.08]">
            <button type="submit" class="btn-primary">Save Settings</button>
        </div>
    </form>
</div>

{% set has_processing = namespace(value=false) %}
{% for ep in episodes %}
{% if ep.status == 'processing' %}
{% set has_processing.value = true %}
{% endif %}
{% endfor %}

{% if has_processing.value %}
<div class="card mb-6">
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3">
        <div class="flex items-center gap-3">
            <div class="w-3 h-3 bg-primary-500 rounded-full animate-pulse"></div>
            <h3 class="font-display text-lg font-semibold">Actively processing</h3>
        </div>
        <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-3 w-full sm:w-auto">
            <div
                class="flex items-center text-sm bg-surface-base px-3 py-2 rounded-xl border border-white/[0.08] w-full sm:w-auto justify-between sm:justify-start">
                <label class="flex items-center cursor-pointer mr-3">
                    <input type="checkbox" id="auto-refresh-toggle" checked
                        class="rounded border-white/20 bg-surface-base text-primary-500 focus:ring-primary-500 mr-2 w-4 h-4">
                    <span class="font-medium text-text-secondary">Auto</span>
                </label>
                <div class="flex items-center">
                    <input type="number" id="refresh-interval" value="30" min="5" max="300"
                        class="w-10 text-center border-none bg-transparent focus:ring-0 p-0 font-bold text-primary-400 appearance-none"
                        style="-moz-appearance: textfield;">
                    <span class="mr-2 text-text-muted">s</span>
                    <span
                        class="text-xs font-mono font-bold bg-primary-500/20 text-primary-400 px-2.5 py-1 rounded-full min-w-[3rem] text-center"
                        id="refresh-countdown">30s</span>
                </div>
            </div>

            <a href="/subscriptions/{{ subscription.slug }}" class="btn-secondary btn-sm">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                    </path>
                </svg>
                Refresh
            </a>
        </div>
    </div>
</div>
{% endif %}

<!-- Episode Filters -->
<div class="mb-8 flex flex-wrap gap-2 items-center justify-between">
    <div class="flex flex-wrap gap-2" id="episode-filters">
        <button onclick="filterEpisodes('all')" data-filter="all" class="filter-btn active badge-info">All
            Episodes</button>
        <button onclick="filterEpisodes('completed')" data-filter="completed"
            class="filter-btn badge-soft">Downloaded</button>
        <button onclick="filterEpisodes('manual')" data-filter="manual" class="filter-btn badge-soft">Manually
            Downloaded</button>
        <button onclick="filterEpisodes('not-downloaded')" data-filter="not-downloaded"
            class="filter-btn badge-soft">Not Downloaded</button>
        <button onclick="filterEpisodes('ignored')" data-filter="ignored" class="filter-btn badge-soft">Deleted</button>
    </div>
</div>

<div class="flex items-center gap-3 w-full md:w-auto">
    <!-- Search Input -->
    <div class="relative flex-1 md:w-64">
        <input type="text" id="episode-search" placeholder="Search episodes..."
            class="w-full bg-surface-base border border-white/[0.1] rounded-lg pl-9 pr-3 py-1.5 text-sm text-text-primary focus:ring-1 focus:ring-primary-500 focus:border-primary-500 transition-colors">
        <svg class="w-4 h-4 text-text-muted absolute left-3 top-1/2 -translate-y-1/2 pointer-events-none" fill="none"
            stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
    </div>

    <!-- View Toggles -->
    <div class="flex items-center bg-surface-base rounded-lg p-1 border border-white/[0.1]">
        <button type="button" id="view-grid"
            class="p-1.5 rounded hover:bg-white/[0.1] text-text-muted hover:text-white transition-colors"
            title="Grid View">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z">
                </path>
            </svg>
        </button>
        <button type="button" id="view-list"
            class="p-1.5 rounded hover:bg-white/[0.1] text-text-muted hover:text-white transition-colors"
            title="List View">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16">
                </path>
            </svg>
        </button>
    </div>
    <div class="text-xs text-text-muted font-medium ml-2 hidden sm:block" id="episode-count">
        All episodes
    </div>
</div>
</div>

<style>
    /* List View Styles */
    #episodes-grid[data-view="list"] {
        grid-template-columns: 1fr !important;
        gap: 0.75rem;
    }

    #episodes-grid[data-view="list"] .episode-card {
        flex-direction: row;
        align-items: center;
        padding: 0.75rem 1rem;
        min-height: auto;
    }

    #episodes-grid[data-view="list"] .episode-content {
        flex: 1;
        display: flex;
        align-items: center;
        gap: 1.5rem;
        padding: 0;
        min-width: 0;
    }

    #episodes-grid[data-view="list"] .episode-header {
        flex: 1;
        min-width: 0;
        margin-bottom: 0 !important;
    }

    #episodes-grid[data-view="list"] .episode-title {
        font-size: 1rem;
        margin-bottom: 0.25rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    #episodes-grid[data-view="list"] .episode-meta {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 0 !important;
    }

    #episodes-grid[data-view="list"] .episode-footer {
        padding: 0;
        margin: 0;
        border: none;
        background: transparent;
        width: auto;
        flex-shrink: 0;
        margin-left: 1rem;
    }

    /* AI Summary in List View */
    #episodes-grid[data-view="list"] .ai-summary-block {
        display: none;
    }
</style>

<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 sm:gap-8" id="episodes-grid">
    {% for ep in episodes %}
    <div class="episode-card card flex flex-col relative overflow-hidden group hover:border-white/[0.15] transition-all duration-300"
        data-status="{{ ep.status }}" data-manual="{{ 'true' if ep.is_manual_download else 'false' }}"
        data-title="{{ ep.title|lower }}" data-date="{{ ep.pub_date }}">

        <!-- Status Indicator Strip -->
        {% if ep.status == 'completed' %}
        <div class="absolute top-0 left-0 bottom-0 w-1 bg-gradient-to-b from-green-500/50 to-green-500/10"></div>
        {% elif ep.status == 'processing' %}
        <div
            class="absolute top-0 left-0 bottom-0 w-1 bg-gradient-to-b from-yellow-500/50 to-yellow-500/10 animate-pulse">
        </div>
        {% endif %}

        <div class="flex-1 p-1 pl-3">
            <!-- Header -->
            <div class="episode-header mb-3">
                <div class="flex justify-between items-start gap-4">
                    <span class="text-[11px] font-medium tracking-wide text-text-muted uppercase">{{ ep.pub_date
                        }}</span>
                    <div class="flex items-center gap-2 shrink-0">
                        {% if ep.status == 'completed' %}
                        <span
                            class="inline-flex items-center gap-1 px-1.5 py-0.5 rounded text-[10px] font-bold bg-green-500/10 text-green-400 border border-green-500/20">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M5 13l4 4L19 7"></path>
                            </svg>
                            Done
                        </span>
                        {% elif ep.status == 'processing' %}
                        <span
                            class="inline-flex items-center gap-1 px-1.5 py-0.5 rounded text-[10px] font-bold bg-yellow-500/10 text-yellow-400 border border-yellow-500/20 animate-pulse">
                            Processing
                        </span>
                        {% elif ep.status == 'ignored' %}
                        <span
                            class="inline-flex items-center gap-1 px-1.5 py-0.5 rounded text-[10px] font-bold bg-white/5 text-text-muted border border-white/10">Deleted</span>
                        {% elif ep.status == 'failed' %}
                        <span
                            class="inline-flex items-center gap-1 px-1.5 py-0.5 rounded text-[10px] font-bold bg-red-500/10 text-red-400 border border-red-500/20">Error</span>
                        {% endif %}
                    </div>
                </div>

                <h3 class="font-display text-xl font-bold leading-tight mt-1 mb-2 text-text-primary group-hover:text-primary-400 transition-colors episode-title"
                    title="{{ ep.title }}">
                    {{ ep.title }}
                </h3>

                <div class="flex items-center gap-3 text-xs text-text-secondary episode-meta">
                    <span
                        class="flex items-center gap-1 bg-surface-base border border-white/[0.06] rounded px-1.5 py-0.5">
                        <svg class="w-3 h-3 opacity-60" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        {{ format_duration(ep.duration) }}
                    </span>
                    {% if ep.listen_count > 0 %}
                    <span class="flex items-center gap-1 text-primary-400/80">
                        <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="2"></circle>
                            <path
                                d="M16.24 7.76a6 6 0 0 1 0 8.49m-8.48-.01a6 6 0 0 1 0-8.48m12.72-4.24a9 9 0 0 1 0 12.73m-16.97 0a9 9 0 0 1 0-12.73">
                            </path>
                        </svg>
                        {{ ep.listen_count }}
                    </span>
                    {% endif %}
                </div>
            </div>

            <!-- Description & AI -->
            <div class="mb-4">
                {% if ep.ai_summary %}
                <div class="mb-2">
                    <button onclick="toggleAiSummary('{{ ep.id }}'); event.stopPropagation();"
                        id="btn-ai-toggle-{{ ep.id }}"
                        class="ai-summary-block w-full text-left px-3 py-2 rounded-lg bg-surface-base border border-primary-500/20 hover:border-primary-500/40 group/ai transition-all">
                        <div
                            class="flex items-center justify-between text-xs font-bold text-primary-300 uppercase tracking-wide mb-1">
                            <span class="flex items-center gap-1.5">
                                <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24">
                                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
                                        stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                </svg>
                                AI Summary Available
                            </span>
                            <span class="text-[10px] opacity-60 group-hover/ai:opacity-100 transition-opacity">Click to
                                Toggle</span>
                        </div>
                        <p class="text-sm text-text-secondary line-clamp-2">{{ ep.ai_summary | striptags }}</p>
                    </button>
                    <!-- Actual AI Content (Hidden) -->
                    <div id="desc-content-ai-{{ ep.id }}"
                        class="hidden mt-2 p-3 bg-surface-base rounded-lg border border-white/[0.08] text-sm text-text-secondary markdown-content">
                        {{ ep.ai_summary|simple_markdown|safe }}
                    </div>
                </div>
                {% endif %}

                {% if ep.description %}
                <details class="group/desc">
                    <summary
                        class="text-xs font-medium text-text-muted cursor-pointer hover:text-text-secondary w-full text-left list-none flex items-center gap-1">
                        <svg class="w-4 h-4 transition-transform group-open/desc:rotate-90" fill="none"
                            stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7">
                            </path>
                        </svg>
                        Show Description
                    </summary>
                    <div
                        class="mt-2 text-sm text-text-secondary leading-relaxed p-3 bg-surface-base/50 rounded-lg border border-white/[0.04]">
                        <div id="desc-content-orig-{{ ep.id }}">
                            {{ ep.description|striptags }}
                        </div>
                    </div>
                </details>
                {% endif %}
            </div>

            <!-- Progress -->
            {% if ep.status == 'processing' %}
            <div class="mb-4 bg-surface-base rounded-lg p-2 border border-white/[0.06]">
                <div class="flex justify-between text-[10px] uppercase font-bold text-text-muted mb-1.5">
                    <span>{{ ep.processing_step }}</span>
                    <span>{{ ep.progress }}%</span>
                </div>
                <div class="h-1.5 w-full bg-white/5 rounded-full overflow-hidden">
                    <div class="h-full bg-primary-500 transition-all duration-500" style="width: {{ ep.progress }}%">
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Action Bar -->
        <div
            class="episode-footer mt-auto pt-3 border-t border-white/[0.06] flex items-center justify-between gap-3 px-1 pl-3">
            <div class="flex items-center gap-2">
                {% if ep.status == 'completed' %}
                <a href="/audio/{{ subscription.slug }}/{{ ep.guid | replace('/', '_') | replace(' ', '_') }}/{{ basename(ep.local_filename) }}"
                    target="_blank" onclick="trackListen({{ ep.id }})"
                    class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-primary-500 text-white text-xs font-bold rounded-lg hover:bg-primary-400 hover:scale-105 transition-all shadow-glow-sm">
                    <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M8 5v14l11-7z" />
                    </svg>
                    Listen
                </a>
                {% endif %}

                {% if ep.transcript_path %}
                <a href="../artifacts/transcript/{{ ep.id }}" target="_blank"
                    class="p-1.5 text-text-muted hover:text-primary-300 hover:bg-white/5 rounded-md transition-colors"
                    title="Transcript">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                        </path>
                    </svg>
                </a>
                {% endif %}
            </div>

            <div class="flex items-center gap-1">
                <!-- Secondary Actions -->
                {% if ep.status == 'unprocessed' or ep.status == 'ignored' %}
                <button onclick="downloadEpisode({{ ep.id }})"
                    class="p-1.5 text-text-muted hover:text-white hover:bg-white/5 rounded-md transition-colors"
                    title="Download">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                    </svg>
                </button>
                {% elif ep.status == 'completed' %}
                <div class="relative inline-block text-left">
                    <button type="button" onclick="toggleDropdown('menu-{{ ep.id }}')"
                        class="p-1.5 text-text-muted hover:text-white hover:bg-white/5 rounded-md transition-colors"
                        title="Options">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z">
                            </path>
                        </svg>
                    </button>
                    <div id="menu-{{ ep.id }}"
                        class="origin-bottom-right absolute right-0 bottom-full mb-2 w-48 rounded-xl shadow-lg bg-surface-elevated border border-white/[0.1] hidden z-50">
                        <div class="py-1">
                            <button onclick="processEpisode({{ ep.id }})"
                                class="w-full text-left px-4 py-2 text-xs font-semibold text-text-secondary hover:text-white hover:bg-white/5">Reprocess</button>
                            <div class="h-px bg-white/[0.06] my-1"></div>
                            <button onclick="deleteEpisode({{ ep.id }})"
                                class="w-full text-left px-4 py-2 text-xs font-semibold text-red-400 hover:bg-red-500/10">Delete
                                File</button>
                        </div>
                    </div>
                </div>
                {% endif %}

                {% if ep.status == 'completed' or ep.status == 'failed' %}
                <!-- Delete Button Direct -->
                {% endif %}
            </div>
        </div>
    </div>
    {% else %}
    <div class="col-span-full text-center py-12 card text-text-muted">
        No episodes found.
    </div>
    {% endfor %}
</div>

<script>
    function filterEpisodes(filter) {
        const cards = document.querySelectorAll('.episode-card');
        const searchTerm = document.getElementById('episode-search').value.toLowerCase();
        let visibleCount = 0;

        // Update active button state
        if (filter !== null) {
            document.querySelectorAll('#episode-filters .filter-btn').forEach(btn => {
                const btnFilter = btn.getAttribute('data-filter');
                if (btnFilter === (filter || 'all')) {
                    btn.classList.remove('badge-soft'); btn.classList.add('badge-info');
                } else {
                    btn.classList.remove('badge-info'); btn.classList.add('badge-soft');
                }
            });
            localStorage.setItem('episode-filter-preference', filter);
        } else {
            filter = localStorage.getItem('episode-filter-preference') || 'all';
        }

        cards.forEach(card => {
            const status = card.getAttribute('data-status');
            const title = card.getAttribute('data-title') || '';
            let show = false;

            // Status Filter logic
            if (filter === 'all') show = true;
            else if (filter === 'completed') show = status === 'completed';
            else if (filter === 'manual') show = card.getAttribute('data-manual') === 'true';
            else if (filter === 'not-downloaded') show = (status === 'unprocessed' || status === 'failed' || status === 'pending');
            else if (filter === 'ignored') show = status === 'ignored';

            // Search Logic
            if (searchTerm && !title.includes(searchTerm)) show = false;

            if (show) { card.classList.remove('hidden'); visibleCount++; }
            else { card.classList.add('hidden'); }
        });

        // Update count text
        const countText = document.getElementById('episode-count');
        if (searchTerm) countText.textContent = `Found ${visibleCount} matches`;
        else if (filter === 'all') countText.textContent = `Showing all episodes (${visibleCount})`;
        else countText.textContent = `Filtered: ${visibleCount} episodes`;
    }

    // Search input listener
    document.getElementById('episode-search').addEventListener('input', () => filterEpisodes(null));

    document.addEventListener('DOMContentLoaded', () => {
        const savedFilter = localStorage.getItem('episode-filter-preference') || 'all';
        filterEpisodes(savedFilter);
    });

    function toggleDescription(id) {
        const desc = document.getElementById(`desc-${id}`);
        if (desc.style.maxHeight === 'none' || desc.classList.contains('max-h-full')) {
            desc.style.maxHeight = '6rem';
            desc.classList.remove('max-h-full');
        } else {
            desc.style.maxHeight = 'none';
            desc.classList.add('max-h-full');
        }
    }

    function toggleAiSummary(id) {
        const originalContent = document.getElementById(`desc-content-orig-${id}`);
        const aiContent = document.getElementById(`desc-content-ai-${id}`);
        const btn = document.getElementById(`btn-ai-toggle-${id}`);

        if (aiContent.classList.contains('hidden')) {
            aiContent.classList.remove('hidden');
            originalContent.classList.add('hidden');
            btn.textContent = 'Show Original';
        } else {
            aiContent.classList.add('hidden');
            originalContent.classList.remove('hidden');
            btn.textContent = 'Show AI Summary';
        }
    }

    async function deleteEpisode(id) {
        if (!confirm('Are you sure you want to permanently delete this episode and all its files?')) return;
        const btn = document.getElementById(`btn-delete-${id}`);
        const originalText = btn.innerHTML;
        btn.disabled = true; btn.innerHTML = 'Deleting...';
        try {
            const response = await fetch(`/api/episodes/${id}`, { method: 'DELETE' });
            if (response.ok) window.location.reload();
            else { alert('Failed to delete episode.'); btn.disabled = false; btn.innerHTML = originalText; }
        } catch (e) { alert('Error deleting episode.'); btn.disabled = false; btn.innerHTML = originalText; }
    }

    async function downloadEpisode(id) {
        if (!confirm('Download this episode manually?')) return;
        try {
            const resp = await fetch(`/episodes/${id}/download`, { method: 'POST' });
            if (resp.ok) { alert('Download queued!'); location.reload(); }
            else alert('Failed to queue download.');
        } catch (e) { alert('Error starting download.'); }
    }

    function toggleDropdown(id) {
        const el = document.getElementById(id);
        if (el.classList.contains('hidden')) {
            document.querySelectorAll('[id^=menu-]').forEach(x => x.classList.add('hidden'));
            el.classList.remove('hidden');
        } else { el.classList.add('hidden'); }
    }

    window.onclick = function (event) {
        if (!event.target.closest('.relative.inline-block.text-left > button') && !event.target.closest('[id^=menu-]')) {
            document.querySelectorAll('[id^=menu-]').forEach(x => x.classList.add('hidden'));
        }
    }

    async function checkNow(id) {
        if (!confirm('Check for new episodes now?')) return;
        await fetch(`/api/subscriptions/${id}/check`, { method: 'POST' });
        alert('Check triggered!'); location.reload();
    }

    async function processEpisode(id, skipTranscription) {
        const action = skipTranscription ? "Reprocess (Keep Transcript)" : "Full Reprocess";
        if (!confirm(`${action}: Are you sure?`)) return;
        const url = `/api/episodes/${id}/process` + (skipTranscription ? "?skip_transcription=true" : "");
        try {
            const response = await fetch(url, { method: 'POST' });
            if (response.ok) location.reload();
            else alert(`Failed to trigger processing: ${response.status}`);
        } catch (e) { alert('Error starting processing.'); }
    }

    async function cancelEpisode(id) {
        if (!confirm('Cancel processing?')) return;
        await fetch(`/api/episodes/${id}/cancel`, { method: 'POST' });
        location.reload();
    }

    async function trackListen(id) {
        try {
            await fetch(`/api/episodes/${id}/track-listen`, { method: 'POST' });
        } catch (e) {
            console.error('Failed to track listen:', e);
        }
    }

    async function deleteSubscription(id) {
        if (!confirm('Delete this subscription? All episodes and files will be removed.')) return;
        const res = await fetch(`/api/subscriptions/${id}`, { method: 'DELETE' });
        if (res.ok) window.location.href = '/';
        else alert('Failed to delete subscription');
    }

    {% if has_processing.value %}
    (function () {
        const toggle = document.getElementById('auto-refresh-toggle');
        const intervalInput = document.getElementById('refresh-interval');
        const countdownDisplay = document.getElementById('refresh-countdown');

        const savedInterval = localStorage.getItem('episodes-refresh-interval');
        const savedToggle = localStorage.getItem('episodes-refresh-enabled');
        if (savedInterval) intervalInput.value = savedInterval;
        if (savedToggle !== null) toggle.checked = savedToggle === 'true';

        let timeLeft = parseInt(intervalInput.value);
        let intervalId = null;

        function updateCountdown() {
            if (!toggle.checked) return;
            timeLeft--;
            if (timeLeft <= 0) {
                localStorage.setItem('episodes-refresh-enabled', toggle.checked);
                localStorage.setItem('episodes-refresh-interval', intervalInput.value);
                window.location.reload();
            } else { countdownDisplay.textContent = timeLeft + 's'; }
        }

        function startTimer() {
            if (intervalId) clearInterval(intervalId);
            timeLeft = parseInt(intervalInput.value);
            if (isNaN(timeLeft) || timeLeft < 5) timeLeft = 5;
            countdownDisplay.textContent = timeLeft + 's';
            if (toggle.checked) {
                intervalId = setInterval(updateCountdown, 1000);
                countdownDisplay.classList.remove('bg-white/5', 'text-text-muted');
                countdownDisplay.classList.add('bg-primary-500/20', 'text-primary-400');
            } else {
                countdownDisplay.textContent = 'Off';
                countdownDisplay.classList.remove('bg-primary-500/20', 'text-primary-400');
                countdownDisplay.classList.add('bg-white/5', 'text-text-muted');
            }
        }

        toggle.onchange = function () { localStorage.setItem('episodes-refresh-enabled', toggle.checked); startTimer(); };
        intervalInput.onchange = function () {
            let val = parseInt(this.value);
            if (isNaN(val) || val < 5) { val = 5; this.value = 5; }
            if (val > 300) { val = 300; this.value = 300; }
            localStorage.setItem('episodes-refresh-interval', val);
            startTimer();
        };
        startTimer();
    })();
    {% endif %}
    // View Toggle Logic for Episodes
    document.addEventListener('DOMContentLoaded', () => {
        function setEpisodeView(mode) {
            const grid = document.getElementById('episodes-grid');
            if (!grid) return;

            // Set attribute
            grid.setAttribute('data-view', mode);

            // Save preference
            try {
                localStorage.setItem('episodes-view-mode', mode);
            } catch (e) {
                console.warn('Could not save view preference', e);
            }

            // Update buttons
            ['grid', 'list'].forEach(m => {
                const btn = document.getElementById(`view-${m}`);
                if (btn) {
                    if (m === mode) {
                        btn.classList.add('bg-primary-500', 'text-white');
                        btn.classList.remove('text-text-muted', 'hover:bg-white/[0.1]');
                    } else {
                        btn.classList.remove('bg-primary-500', 'text-white');
                        btn.classList.add('text-text-muted', 'hover:bg-white/[0.1]');
                    }
                }
            });
        }

        // Init view
        const savedView = localStorage.getItem('episodes-view-mode') || 'grid';
        setEpisodeView(savedView);

        // Attach listeners
        ['grid', 'list'].forEach(m => {
            const btn = document.getElementById(`view-${m}`);
            if (btn) {
                btn.addEventListener('click', () => setEpisodeView(m));
            }
        });
    });
</script>
{% endblock %}