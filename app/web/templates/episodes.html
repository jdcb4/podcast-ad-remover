{% extends "base.html" %}

{% block content %}
<div class="mb-6">
    <a href="/" class="text-primary-400 hover:text-primary-300 transition-colors">&larr; Back to Subscriptions</a>
</div>

<div class="card mb-10 overflow-hidden relative group border-0 bg-transparent shadow-none p-0">
    <!-- Cinematic Header -->
    <div
        class="relative overflow-hidden rounded-3xl p-6 md:p-10 border border-white/5 bg-surface-elevated/40 backdrop-blur-md">
        <div class="absolute inset-0 z-0">
            {% if subscription.image_url %}
            <div class="absolute inset-0 bg-cover bg-center blur-[100px] opacity-30 scale-125"
                style="background-image: url('{{ subscription.image_url }}');"></div>
            {% endif %}
            <div class="absolute inset-0 bg-gradient-to-br from-bg-surface/90 via-bg-surface/60 to-transparent"></div>
        </div>

        <div class="relative z-10 flex flex-col md:flex-row items-center md:items-start gap-8 md:gap-12">
            <!-- Artwork -->
            {% if subscription.image_url %}
            <div class="shrink-0 relative">
                <img src="{{ subscription.image_url }}" alt="{{ subscription.title }}"
                    class="w-48 h-48 md:w-56 md:h-56 object-cover rounded-2xl shadow-[0_20px_50px_rgba(0,0,0,0.5)] ring-1 ring-white/10 group-hover:scale-[1.02] transition-transform duration-500">
                <div class="absolute inset-0 rounded-2xl ring-inset ring-1 ring-white/20"></div>
            </div>
            {% endif %}

            <!-- Content -->
            <div class="flex-1 min-w-0 text-center md:text-left pt-2 pb-2">
                <div class="mb-4">
                    <h1
                        class="font-display text-4xl md:text-5xl font-extrabold tracking-tight text-white mb-4 leading-tight">
                        {{ subscription.title }}
                    </h1>
                    {% if subscription.description %}
                    <div
                        class="text-text-secondary leading-relaxed max-w-2xl text-base font-medium opacity-90 line-clamp-3 md:line-clamp-4">
                        {{ subscription.description | striptags }}
                    </div>
                    {% endif %}
                </div>

                <div class="flex flex-wrap items-center justify-center md:justify-start gap-4 mt-8">
                    <button onclick="checkNow({{ subscription.id }})"
                        class="btn-primary px-8 py-3 rounded-2xl shadow-xl shadow-primary-500/30 hover:shadow-primary-500/50 transition-all font-bold">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                            </path>
                        </svg>
                        Refresh Show
                    </button>
                    <div class="h-10 w-px bg-white/10 hidden md:block"></div>
                    <div class="flex gap-2">
                        <a href="{{ links.direct }}"
                            class="btn-secondary h-12 w-12 p-0 flex items-center justify-center rounded-2xl group/btn"
                            title="Direct RSS Feed" target="_blank">
                            <svg class="w-5 h-5 group-hover/btn:text-primary-400 transition-colors" fill="none"
                                stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 5c7.18 0 13 5.82 13 13M6 11a7 7 0 017 7m-6 0a1 1 0 11-2 0 1 1 0 012 0z">
                                </path>
                            </svg>
                        </a>
                        <a href="/subscribe/apple?url={{ links.apple | urlencode }}"
                            class="btn-secondary h-12 w-12 p-0 flex items-center justify-center rounded-2xl group/btn"
                            title="Subscribe on Apple Podcasts" target="_blank">
                            <svg class="w-5 h-5 group-hover/btn:text-primary-400 transition-colors" fill="currentColor"
                                viewBox="0 0 24 24">
                                <path
                                    d="M11.996 11.53c0-.39.123-.746.368-1.066.241-.322.569-.481.986-.481.365 0 .66.126.885.378s.338.563.338.932h1.693c0-.858-.291-1.574-.874-2.147-.582-.573-1.267-.859-2.053-.859-1.033 0-1.872.378-2.518 1.133s-.969 1.666-.969 2.731c0 1.056.332 1.956.996 2.702.664.746 1.494 1.119 2.491 1.119.866 0 1.579-.312 2.138-.938s.839-1.428.839-2.408h-1.693c0 .546-.145.986-.434 1.32s-.657.501-1.104.501c-.514 0-.91-.186-1.189-.559-.278-.372-.418-.934-.418-1.684v-.194z">
                                </path>
                            </svg>
                        </a>
                    </div>
                </div>
            </div>

            <button onclick="deleteSubscription({{ subscription.id }})"
                class="absolute top-6 right-6 p-3 text-white/20 hover:text-red-400 hover:bg-red-500/10 rounded-2xl transition-all"
                title="Delete Show">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                    </path>
                </svg>
            </button>
        </div>
    </div>
</div>
</div>

<div class="card mb-6">
    <div class="flex justify-between items-center mb-4 cursor-pointer"
        onclick="document.getElementById('settings-form').classList.toggle('hidden')">
        <h3 class="font-display text-xl font-bold">Processing Settings</h3>
        <span class="text-text-muted text-sm hover:text-text-secondary transition-colors">Toggle</span>
    </div>

    <form id="settings-form" action="/subscriptions/{{ subscription.id }}/settings" method="POST" class="hidden">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 md:gap-12">
            <div class="space-y-6">
                <h4 class="font-semibold border-b border-white/[0.08] pb-2">Content Removal</h4>
                <label class="flex items-center cursor-pointer">
                    <input type="checkbox" name="remove_ads" value="true" {% if subscription.remove_ads %}checked{%
                        endif %}
                        class="h-4 w-4 text-primary-500 rounded bg-surface-base border-white/20 focus:ring-primary-500">
                    <span class="ml-3">Remove Ads</span>
                </label>
                <label class="flex items-center cursor-pointer">
                    <input type="checkbox" name="remove_promos" value="true" {% if subscription.remove_promos
                        %}checked{% endif %}
                        class="h-4 w-4 text-primary-500 rounded bg-surface-base border-white/20 focus:ring-primary-500">
                    <span class="ml-3">Remove Promos</span>
                </label>
                <label class="flex items-center cursor-pointer">
                    <input type="checkbox" name="remove_intros" value="true" {% if subscription.remove_intros
                        %}checked{% endif %}
                        class="h-4 w-4 text-primary-500 rounded bg-surface-base border-white/20 focus:ring-primary-500">
                    <span class="ml-3">Remove Intros</span>
                </label>
                <label class="flex items-center cursor-pointer">
                    <input type="checkbox" name="remove_outros" value="true" {% if subscription.remove_outros
                        %}checked{% endif %}
                        class="h-4 w-4 text-primary-500 rounded bg-surface-base border-white/20 focus:ring-primary-500">
                    <span class="ml-3">Remove Outros</span>
                </label>

                <div class="pt-4 border-t border-white/[0.08]">
                    <h4 class="font-semibold mb-3">Retention Policy</h4>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm text-text-secondary mb-2">Auto-Downloads (Episodes to
                                Keep)</label>
                            <select name="retention_limit" class="select">
                                <option value="0" {% if subscription.retention_limit==0 %}selected{% endif %}>None
                                    (Manual Only)</option>
                                <option value="1" {% if (subscription.retention_limit is none or
                                    subscription.retention_limit==1) %}selected{% endif %}>Keep Latest 1 (Default)
                                </option>
                                <option value="2" {% if subscription.retention_limit==2 %}selected{% endif %}>Keep
                                    Latest 2</option>
                                <option value="3" {% if subscription.retention_limit==3 %}selected{% endif %}>Keep
                                    Latest 3</option>
                                <option value="5" {% if subscription.retention_limit==5 %}selected{% endif %}>Keep
                                    Latest 5</option>
                                <option value="10" {% if subscription.retention_limit==10 %}selected{% endif %}>Keep
                                    Latest 10</option>
                                <option value="20" {% if subscription.retention_limit==20 %}selected{% endif %}>Keep
                                    Latest 20</option>
                                <option value="1000" {% if subscription.retention_limit>=1000 %}selected{% endif %}>Keep
                                    All</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm text-text-secondary mb-2">Manual Downloads</label>
                            <select name="manual_retention_days" class="select">
                                <option value="7" {% if subscription.manual_retention_days==7 %}selected{% endif %}>Keep
                                    7 Days</option>
                                <option value="14" {% if (subscription.manual_retention_days or 14)==14 %}selected{%
                                    endif %}>Keep 14 Days</option>
                                <option value="30" {% if subscription.manual_retention_days==30 %}selected{% endif %}>
                                    Keep 30 Days</option>
                                <option value="90" {% if subscription.manual_retention_days==90 %}selected{% endif %}>
                                    Keep 90 Days</option>
                                <option value="365" {% if subscription.manual_retention_days==365 %}selected{% endif %}>
                                    Keep 1 Year</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="space-y-4">
                <h4 class="font-semibold border-b border-white/[0.08] pb-2">Features</h4>
                <label class="flex items-center cursor-pointer">
                    <input type="checkbox" name="ai_rewrite_description" value="true" {% if
                        subscription.ai_rewrite_description %}checked{% endif %}
                        class="h-4 w-4 text-primary-500 rounded bg-surface-base border-white/20 focus:ring-primary-500">
                    <span class="ml-3">Rewrite Description (AI Text)</span>
                </label>
                <label class="flex items-center cursor-pointer">
                    <input type="checkbox" name="ai_audio_summary" value="true" {% if subscription.ai_audio_summary
                        %}checked{% endif %}
                        class="h-4 w-4 text-primary-500 rounded bg-surface-base border-white/20 focus:ring-primary-500">
                    <span class="ml-3">Append Audio Summary (AI TTS)</span>
                </label>
                <label class="flex items-center cursor-pointer">
                    <input type="checkbox" name="append_title_intro" value="true" {% if subscription.append_title_intro
                        %}checked{% endif %}
                        class="h-4 w-4 text-primary-500 rounded bg-surface-base border-white/20 focus:ring-primary-500">
                    <span class="ml-3">Append Audio Title as Intro (TTS)</span>
                </label>

                <div class="mt-4">
                    <label class="block text-sm font-medium text-text-secondary mb-2">Custom Ad Detection
                        Instructions</label>
                    <textarea name="custom_instructions" rows="3" class="input font-mono text-sm"
                        placeholder="E.g., 'Remove segments discussing XYZ', 'Keep promos for host's other shows'">{{ subscription.custom_instructions or '' }}</textarea>
                </div>
            </div>
        </div>

        <div class="mt-6 flex justify-end pt-4 border-t border-white/[0.08]">
            <button type="submit" class="btn-primary">Save Settings</button>
        </div>
    </form>
</div>

{% set has_processing = namespace(value=false) %}
{% for ep in episodes %}
{% if ep.status == 'processing' %}
{% set has_processing.value = true %}
{% endif %}
{% endfor %}

{% if has_processing.value %}
<div class="card mb-6">
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3">
        <div class="flex items-center gap-3">
            <div class="w-3 h-3 bg-primary-500 rounded-full animate-pulse"></div>
            <h3 class="font-display text-lg font-semibold">Actively processing</h3>
        </div>
        <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-3 w-full sm:w-auto">
            <div
                class="flex items-center text-sm bg-surface-base px-3 py-2 rounded-xl border border-white/[0.08] w-full sm:w-auto justify-between sm:justify-start">
                <label class="flex items-center cursor-pointer mr-3">
                    <input type="checkbox" id="auto-refresh-toggle" checked
                        class="rounded border-white/20 bg-surface-base text-primary-500 focus:ring-primary-500 mr-2 w-4 h-4">
                    <span class="font-medium text-text-secondary">Auto</span>
                </label>
                <div class="flex items-center">
                    <input type="number" id="refresh-interval" value="30" min="5" max="300"
                        class="w-10 text-center border-none bg-transparent focus:ring-0 p-0 font-bold text-primary-400 appearance-none"
                        style="-moz-appearance: textfield;">
                    <span class="mr-2 text-text-muted">s</span>
                    <span
                        class="text-xs font-mono font-bold bg-primary-500/20 text-primary-400 px-2.5 py-1 rounded-full min-w-[3rem] text-center"
                        id="refresh-countdown">30s</span>
                </div>
            </div>

            <a href="/subscriptions/{{ subscription.slug }}" class="btn-secondary btn-sm">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                    </path>
                </svg>
                Refresh
            </a>
        </div>
    </div>
</div>
{% endif %}

<!-- Episode Filters -->
<div class="mb-8 flex flex-wrap gap-2 items-center justify-between">
    <div class="flex flex-wrap gap-2" id="episode-filters">
        <button onclick="filterEpisodes('all')" data-filter="all" class="filter-btn active badge-info">All
            Episodes</button>
        <button onclick="filterEpisodes('completed')" data-filter="completed"
            class="filter-btn badge-soft">Downloaded</button>
        <button onclick="filterEpisodes('manual')" data-filter="manual" class="filter-btn badge-soft">Manually
            Downloaded</button>
        <button onclick="filterEpisodes('not-downloaded')" data-filter="not-downloaded"
            class="filter-btn badge-soft">Not Downloaded</button>
        <button onclick="filterEpisodes('ignored')" data-filter="ignored" class="filter-btn badge-soft">Deleted</button>
    </div>
</div>

<div class="flex items-center gap-3 w-full md:w-auto">
    <!-- Search Input -->
    <div class="relative flex-1 md:w-80">
        <input type="text" id="episode-search" placeholder="Search episodes..."
            class="w-full bg-surface-base border border-white/[0.1] rounded-2xl pl-12 pr-4 py-3 text-sm text-text-primary focus:ring-2 focus:ring-primary-500/50 focus:border-primary-500 transition-all shadow-inner">
        <svg class="w-5 h-5 text-text-muted absolute left-4 top-1/2 -translate-y-1/2 pointer-events-none" fill="none"
            stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
    </div>

    <!-- View Toggles -->
    <div class="flex items-center bg-surface-base rounded-lg p-1 border border-white/[0.1]">
        <button type="button" id="view-grid"
            class="p-1.5 rounded hover:bg-white/[0.1] text-text-muted hover:text-white transition-colors"
            title="Grid View">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z">
                </path>
            </svg>
        </button>
        <button type="button" id="view-list"
            class="p-1.5 rounded hover:bg-white/[0.1] text-text-muted hover:text-white transition-colors"
            title="List View">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16">
                </path>
            </svg>
        </button>
    </div>
    <div class="text-xs text-text-muted font-medium ml-2 hidden sm:block" id="episode-count">
        All episodes
    </div>
</div>
</div>

<style>
    /* List View Styles */
    #episodes-grid[data-view="list"] {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    #episodes-grid[data-view="list"] .episode-card {
        display: grid;
        grid-template-columns: 48px 110px 80px 1fr 200px;
        grid-template-areas: "check date dur title actions"
            "desc desc desc desc desc";
        align-items: center;
        padding: 0;
        min-height: 52px;
        gap: 0;
        overflow: visible !important;
        /* Allow menus to overflow */
    }

    /* Column 1: Checkbox */
    #episodes-grid[data-view="list"] .episode-card>div:first-child {
        grid-area: check;
        position: static !important;
        opacity: 1 !important;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 52px;
        padding: 0;
        z-index: 10;
    }

    /* Wrap all middle content */
    #episodes-grid[data-view="list"] .episode-card>div:nth-child(2) {
        display: contents;
    }

    /* Metadata & Sub-divs contents */
    #episodes-grid[data-view="list"] .episode-card .flex.justify-between.items-start.mb-3,
    #episodes-grid[data-view="list"] .episode-card .flex.items-center.gap-2.text-\[11px\] {
        display: contents;
    }

    /* Column 2: Date */
    #episodes-grid[data-view="list"] .episode-card .date-relative {
        grid-area: date;
        font-weight: 700;
        color: var(--text-primary);
        white-space: nowrap;
        font-size: 0.75rem;
        text-transform: uppercase;
        display: flex;
        align-items: center;
        height: 52px;
    }

    /* Column 3: Duration */
    #episodes-grid[data-view="list"] .episode-card .flex.items-center.gap-2.text-\[11px\]>span:last-child {
        grid-area: dur;
        color: var(--text-muted);
        text-align: left;
        font-size: 0.75rem;
        font-family: ui-monospace, monospace;
        display: flex;
        align-items: center;
        height: 52px;
    }

    /* Column 4: Title */
    #episodes-grid[data-view="list"] .episode-card h3 {
        grid-area: title;
        margin: 0 !important;
        padding: 0 1.5rem;
        font-size: 0.92rem;
        font-weight: 600;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        height: 52px;
    }

    /* Column 5: Actions */
    #episodes-grid[data-view="list"] .episode-card .list-actions {
        grid-area: actions;
        display: flex;
        align-items: center;
        justify-content: flex-end;
        gap: 0.25rem;
        padding-right: 1rem;
        height: 52px;
        z-index: 30;
        /* Above expansion row */
    }

    /* Standardization for all Action Buttons */
    #episodes-grid[data-view="list"] .episode-card .list-actions a,
    #episodes-grid[data-view="list"] .episode-card .list-actions button {
        width: 32px !important;
        height: 32px !important;
        min-width: 32px !important;
        padding: 0 !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        border-radius: 9999px !important;
        background: transparent !important;
        border: none !important;
        color: var(--text-muted) !important;
        transition: all 0.2s;
    }

    #episodes-grid[data-view="list"] .episode-card .list-actions .bg-primary-500 {
        background-color: var(--primary-500) !important;
        color: white !important;
    }

    #episodes-grid[data-view="list"] .episode-card .list-actions a:hover,
    #episodes-grid[data-view="list"] .episode-card .list-actions button:hover {
        background-color: rgba(255, 255, 255, 0.08) !important;
        color: white !important;
    }

    /* Dropdown alignment fix for list view */
    #episodes-grid[data-view="list"] .episode-card .list-actions .origin-bottom-right {
        bottom: 100% !important;
        margin-bottom: 0.5rem;
        z-index: 100 !important;
    }

    /* Hide elements not needed in list view */
    #episodes-grid[data-view="list"] .episode-card .text-white\/10,
    #episodes-grid[data-view="list"] .episode-card .flex.items-center.gap-3:not(.flex.justify-between.items-start.mb-3 div) {
        display: none;
    }

    /* Expansion Row Styling - Improved Alignment */
    #episodes-grid[data-view="list"] .group\/ep-desc {
        grid-area: desc;
        display: none;
        padding: 1.5rem 2.5rem 2rem 158px;
        /* Balanced left padding */
        background: rgba(0, 0, 0, 0.15);
        border-top: 1px solid rgba(255, 255, 255, 0.03);
        font-size: 0.9rem;
        line-height: 1.6;
        color: var(--text-secondary);
    }

    #episodes-grid[data-view="list"] .episode-card.expanded .group\/ep-desc {
        display: block;
    }

    #episodes-grid[data-view="list"] .episode-card .mt-4.bg-surface-base {
        display: none;
    }
</style>

<div class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-12 mb-20" id="episodes-grid">
    {% for ep in episodes %}
    <div class="episode-card card flex flex-col relative overflow-hidden group transition-all duration-300 h-full border hover:border-white/10"
        data-status="{{ ep.status }}" data-manual="{{ 'true' if ep.is_manual_download else 'false' }}"
        data-title="{{ ep.title|lower }}" data-date="{{ ep.pub_date }}" id="card-{{ ep.id }}">

        <!-- Batch Selection Checkbox -->
        <div class="absolute top-4 left-4 z-20 opacity-0 group-hover:opacity-100 transition-opacity"
            onclick="event.stopPropagation();">
            <input type="checkbox" name="episode_ids" value="{{ ep.id }}"
                class="h-5 w-5 rounded border-white/20 bg-surface-elevated text-primary-500 focus:ring-primary-500 cursor-pointer shadow-lg episode-checkbox">
        </div>

        <!-- Main Clickable Area -->
        <div class="flex-1 p-4 flex flex-col cursor-pointer relative" onclick="toggleDescription('{{ ep.id }}')">

            <!-- Metadata Row -->
            <div class="flex justify-between items-start mb-3">
                <div class="flex items-center gap-2 text-[11px] font-bold tracking-wider text-text-muted uppercase">
                    <span class="date-relative" data-date="{{ ep.pub_date }}">{{ ep.pub_date }}</span>
                    <span class="text-white/10">â€¢</span>
                    <span>{{ format_duration(ep.duration) }}</span>
                </div>

                <!-- Status Icons (Semantic) -->
                <div class="flex items-center gap-3">
                    {% if ep.status == 'completed' %}
                    <div class="text-success" data-tooltip="Downloaded">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    {% elif ep.status == 'processing' %}
                    <div class="text-warning animate-pulse" data-tooltip="Processing">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    {% elif ep.status == 'ignored' %}
                    <div class="text-text-muted/60 hover:text-text-muted" data-tooltip="Deleted">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                            </path>
                        </svg>
                    </div>
                    {% elif ep.status == 'failed' %}
                    <div class="text-error" data-tooltip="Failed">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Title -->
            <h3 class="font-display text-lg font-bold text-text-primary leading-snug mb-3 group-hover:text-primary-300 transition-colors line-clamp-2"
                title="{{ ep.title }}">
                {{ ep.title }}
            </h3>

            <!-- Description & AI (Click to Expand Entire Block) -->
            <div class="mb-4 text-sm leading-relaxed text-text-secondary cursor-pointer group/ep-desc relative"
                onclick="this.classList.toggle('expanded'); event.stopPropagation();">

                {% if ep.ai_summary %}
                <!-- AI Summary View -->
                <div
                    class="p-4 bg-primary-500/5 rounded-2xl border border-primary-500/10 mb-3 group/ai transition-all hover:bg-primary-500/[0.08]">
                    <div
                        class="flex items-center gap-2 mb-3 text-primary-400 text-[10px] font-bold uppercase tracking-[0.2em]">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                            <path
                                d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z">
                            </path>
                        </svg>
                        AI Insights
                    </div>
                    <div class="markdown-content text-white line-clamp-4 group-[.expanded]/ep-desc:line-clamp-none transition-all duration-500 ease-in-out"
                        id="ai-sum-{{ ep.id }}">
                        {{ ep.ai_summary|simple_markdown|safe }}
                    </div>
                    <div
                        class="mt-4 text-[10px] font-bold text-primary-400/60 uppercase tracking-widest group-[.expanded]/ep-desc:hidden flex items-center gap-1">
                        Full Summary <svg class="w-2.5 h-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 9l-7 7-7-7">
                            </path>
                        </svg>
                    </div>
                </div>

                {% if ep.description %}
                <details class="group/details mt-2" onclick="event.stopPropagation()">
                    <summary
                        class="text-[10px] font-bold text-text-muted cursor-pointer hover:text-text-secondary list-none flex items-center gap-2 opacity-60 hover:opacity-100 transition-opacity uppercase tracking-widest pl-1">
                        <span class="group-open/details:hidden">Original Description</span>
                        <span class="hidden group-open/details:block">Hide Description</span>
                        <svg class="w-3 h-3 group-open/details:rotate-180 transition-transform" fill="none"
                            stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M19 9l-7 7-7-7">
                            </path>
                        </svg>
                    </summary>
                    <div
                        class="mt-4 text-text-secondary/80 text-[13px] pl-4 border-l-2 border-white/5 space-y-3 leading-relaxed">
                        {{ ep.description|clean_description }}
                    </div>
                </details>
                {% endif %}

                {% else %}
                <!-- Fallback: Standard Description -->
                {% if ep.description %}
                <div class="py-1 px-1">
                    <div
                        class="line-clamp-4 group-[.expanded]/ep-desc:line-clamp-none transition-all duration-500 ease-in-out text-text-secondary/90">
                        {{ ep.description|clean_description }}
                    </div>
                    <div
                        class="mt-4 text-[10px] font-bold text-primary-400/60 group-hover/ep-desc:text-primary-400 group-hover/ep-desc:opacity-100 transition-all flex items-center gap-1 group-[.expanded]/ep-desc:hidden uppercase tracking-widest">
                        Read More <svg class="w-2.5 h-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 9l-7 7-7-7">
                            </path>
                        </svg>
                    </div>
                </div>
                {% endif %}
                {% endif %}
            </div>

            <!-- Progress Bar -->
            {% if ep.status == 'processing' %}
            <div class="mt-4 bg-surface-base rounded-md p-1.5 border border-white/[0.06]">
                <div class="flex justify-between text-[10px] uppercase font-bold text-text-muted mb-1">
                    <span>{{ ep.processing_step }}</span>
                    <span>{{ ep.progress }}%</span>
                </div>
                <div class="h-1 w-full bg-white/5 rounded-full overflow-hidden">
                    <div class="h-full bg-warning transition-all duration-500" style="width: {{ ep.progress }}%"></div>
                </div>
            </div>
            {% endif %}

        </div>

        <!-- Footer / Actions -->
        <div class="px-4 py-3 border-t border-white/[0.06] flex justify-between items-center bg-surface-base/30 backdrop-blur-sm"
            onclick="event.stopPropagation();">

            <div class="flex items-center gap-3">
                {% if ep.transcript_path %}
                <a href="/episodes/{{ ep.id }}/transcript"
                    class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-surface-elevated border border-white/5 text-xs font-medium text-text-secondary hover:text-white hover:border-white/20 transition-all"
                    title="Read Transcript">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                        </path>
                    </svg>
                    Transcript
                </a>
                {% endif %}

                {% if ep.report_path or ep.ad_report_path %}
                <a href="/artifacts/report/{{ ep.id }}" target="_blank"
                    class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-surface-elevated border border-white/5 text-xs font-medium text-text-secondary hover:text-white hover:border-white/20 transition-all"
                    title="View Removal Report">
                    <svg class="w-3.5 h-3.5 text-accent-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                        </path>
                    </svg>
                    Report
                </a>
                {% endif %}
            </div>

            <!-- Quick Actions -->
            <div class="flex items-center gap-2 list-actions">
                {% if ep.status == 'completed' %}
                <a href="/audio/{{ subscription.slug }}/{{ ep.guid | replace('/', '_') | replace(' ', '_') }}/{{ basename(ep.local_filename) }}"
                    target="_blank" onclick="trackListen({{ ep.id }})"
                    class="p-2 bg-primary-500 rounded-full text-white hover:bg-primary-400 hover:scale-105 transition-all shadow-lg"
                    title="Play">
                    <svg class="w-4 h-4 ml-0.5" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M8 5v14l11-7z" />
                    </svg>
                </a>
                {% elif ep.status == 'unprocessed' or ep.status == 'ignored' %}
                <button onclick="downloadEpisode({{ ep.id }})"
                    class="p-2 text-text-muted hover:text-white hover:bg-white/10 rounded-full transition-colors"
                    title="Download">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                    </svg>
                </button>
                {% endif %}

                <!-- Options Menu (Always show if not ignored or failed?) -->
                <div class="relative inline-block text-left">
                    <button onclick="toggleDropdown('menu-{{ ep.id }}')"
                        class="p-2 text-text-muted hover:text-white transition-colors rounded-full hover:bg-white/10"
                        title="More">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 5v.01M12 12v.01M12 19v.01"></path>
                        </svg>
                    </button>
                    <!-- Dropdown Menu -->
                    <div id="menu-{{ ep.id }}"
                        class="origin-bottom-right absolute right-0 bottom-full mb-2 w-48 rounded-xl shadow-xl bg-surface-elevated border border-white/10 hidden z-50 overflow-hidden">
                        <div class="p-1">
                            <button onclick="processEpisode({{ ep.id }})"
                                class="w-full text-left px-4 py-2.5 text-xs font-semibold text-text-secondary hover:text-white hover:bg-white/5 rounded-lg flex items-center gap-2">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                                    </path>
                                </svg>
                                Reprocess Episode
                            </button>
                            <button onclick="deleteEpisode({{ ep.id }})"
                                class="w-full text-left px-4 py-2.5 text-xs font-semibold text-red-400 hover:bg-red-500/10 rounded-lg flex items-center gap-2">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                                    </path>
                                </svg>
                                Delete File
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="col-span-full text-center py-12 card text-text-muted">
        No episodes found.
    </div>
    {% endfor %}
</div>

<script>
    function filterEpisodes(filter) {
        const cards = document.querySelectorAll('.episode-card');
        const searchTerm = document.getElementById('episode-search').value.toLowerCase();
        let visibleCount = 0;

        // Update active button state
        if (filter !== null) {
            document.querySelectorAll('#episode-filters .filter-btn').forEach(btn => {
                const btnFilter = btn.getAttribute('data-filter');
                if (btnFilter === (filter || 'all')) {
                    btn.classList.remove('badge-soft'); btn.classList.add('badge-info');
                } else {
                    btn.classList.remove('badge-info'); btn.classList.add('badge-soft');
                }
            });
            localStorage.setItem('episode-filter-preference', filter);
        } else {
            filter = localStorage.getItem('episode-filter-preference') || 'all';
        }

        cards.forEach(card => {
            const status = card.getAttribute('data-status');
            const title = card.getAttribute('data-title') || '';
            let show = false;

            // Status Filter logic
            if (filter === 'all') show = true;
            else if (filter === 'completed') show = status === 'completed';
            else if (filter === 'manual') show = card.getAttribute('data-manual') === 'true';
            else if (filter === 'not-downloaded') show = (status === 'unprocessed' || status === 'failed' || status === 'pending');
            else if (filter === 'ignored') show = status === 'ignored';

            // Search Logic
            if (searchTerm && !title.includes(searchTerm)) show = false;

            if (show) { card.classList.remove('hidden'); visibleCount++; }
            else { card.classList.add('hidden'); }
        });

        // Update count text
        const countText = document.getElementById('episode-count');
        if (searchTerm) countText.textContent = `Found ${visibleCount} matches`;
        else if (filter === 'all') countText.textContent = `Showing all episodes (${visibleCount})`;
        else countText.textContent = `Filtered: ${visibleCount} episodes`;
    }

    function timeAgo(dateParam) {
        if (!dateParam) return null;
        const date = typeof dateParam === 'object' ? dateParam : new Date(dateParam);
        const today = new Date();
        const seconds = Math.round((today - date) / 1000);
        const minutes = Math.round(seconds / 60);
        const isToday = today.toDateString() === date.toDateString();

        if (isToday) return 'Today';
        if (seconds < 86400 * 2 && today.getDate() - date.getDate() === 1) return 'Yesterday';
        if (seconds < 86400 * 7) return `${Math.floor(seconds / 86400)} days ago`;

        return date.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
    }

    // Format Dates on Load with Relative Logic
    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.date-relative').forEach(el => {
            try {
                const dateStr = el.getAttribute('data-date');
                const rel = timeAgo(dateStr);
                if (rel) el.textContent = rel;
            } catch (e) { }
        });
    });

    function toggleDescription(id) {
        const card = document.getElementById('card-' + id);
        if (card) {
            card.classList.toggle('expanded');
        }
    }



    // Unified Toggle
    function toggleAiSummary(id) {
        // Now handled by toggleDescription logic for the primary view
    }

    // Format Dates on Load
    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.date-formatted').forEach(el => {
            try {
                const dateStr = el.textContent.trim();
                const date = new Date(dateStr);
                if (!isNaN(date)) {
                    // Use simple format: "Dec 23, 2023"
                    el.textContent = date.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' });
                }
            } catch (e) { }
        });
    });

    async function deleteEpisode(id) {
        if (!confirm('Are you sure you want to permanently delete this episode and all its files?')) return;
        const btn = document.getElementById(`btn-delete-${id}`);
        const originalText = btn.innerHTML;
        btn.disabled = true; btn.innerHTML = 'Deleting...';
        try {
            const response = await fetch(`/api/episodes/${id}`, { method: 'DELETE' });
            if (response.ok) window.location.reload();
            else { alert('Failed to delete episode.'); btn.disabled = false; btn.innerHTML = originalText; }
        } catch (e) { alert('Error deleting episode.'); btn.disabled = false; btn.innerHTML = originalText; }
    }

    async function downloadEpisode(id) {
        if (!confirm('Download this episode manually?')) return;
        try {
            const resp = await fetch(`/episodes/${id}/download`, { method: 'POST' });
            if (resp.ok) { alert('Download queued!'); location.reload(); }
            else alert('Failed to queue download.');
        } catch (e) { alert('Error starting download.'); }
    }

    function toggleDropdown(id) {
        const el = document.getElementById(id);
        if (el.classList.contains('hidden')) {
            document.querySelectorAll('[id^=menu-]').forEach(x => x.classList.add('hidden'));
            el.classList.remove('hidden');
        } else { el.classList.add('hidden'); }
    }

    window.onclick = function (event) {
        if (!event.target.closest('.relative.inline-block.text-left > button') && !event.target.closest('[id^=menu-]')) {
            document.querySelectorAll('[id^=menu-]').forEach(x => x.classList.add('hidden'));
        }
    }

    async function checkNow(id) {
        if (!confirm('Check for new episodes now?')) return;
        await fetch(`/api/subscriptions/${id}/check`, { method: 'POST' });
        alert('Check triggered!'); location.reload();
    }

    async function processEpisode(id, skipTranscription) {
        const action = skipTranscription ? "Reprocess (Keep Transcript)" : "Full Reprocess";
        if (!confirm(`${action}: Are you sure?`)) return;
        const url = `/api/episodes/${id}/process` + (skipTranscription ? "?skip_transcription=true" : "");
        try {
            const response = await fetch(url, { method: 'POST' });
            if (response.ok) location.reload();
            else alert(`Failed to trigger processing: ${response.status}`);
        } catch (e) { alert('Error starting processing.'); }
    }

    async function cancelEpisode(id) {
        if (!confirm('Cancel processing?')) return;
        await fetch(`/api/episodes/${id}/cancel`, { method: 'POST' });
        location.reload();
    }

    async function trackListen(id) {
        try {
            await fetch(`/api/episodes/${id}/track-listen`, { method: 'POST' });
        } catch (e) {
            console.error('Failed to track listen:', e);
        }
    }

    async function deleteSubscription(id) {
        if (!confirm('Delete this subscription? All episodes and files will be removed.')) return;
        const res = await fetch(`/api/subscriptions/${id}`, { method: 'DELETE' });
        if (res.ok) window.location.href = '/';
        else alert('Failed to delete subscription');
    }

    {% if has_processing.value %}
    (function () {
        const toggle = document.getElementById('auto-refresh-toggle');
        const intervalInput = document.getElementById('refresh-interval');
        const countdownDisplay = document.getElementById('refresh-countdown');

        const savedInterval = localStorage.getItem('episodes-refresh-interval');
        const savedToggle = localStorage.getItem('episodes-refresh-enabled');
        if (savedInterval) intervalInput.value = savedInterval;
        if (savedToggle !== null) toggle.checked = savedToggle === 'true';

        let timeLeft = parseInt(intervalInput.value);
        let intervalId = null;

        function updateCountdown() {
            if (!toggle.checked) return;
            timeLeft--;
            if (timeLeft <= 0) {
                localStorage.setItem('episodes-refresh-enabled', toggle.checked);
                localStorage.setItem('episodes-refresh-interval', intervalInput.value);
                window.location.reload();
            } else { countdownDisplay.textContent = timeLeft + 's'; }
        }

        function startTimer() {
            if (intervalId) clearInterval(intervalId);
            timeLeft = parseInt(intervalInput.value);
            if (isNaN(timeLeft) || timeLeft < 5) timeLeft = 5;
            countdownDisplay.textContent = timeLeft + 's';
            if (toggle.checked) {
                intervalId = setInterval(updateCountdown, 1000);
                countdownDisplay.classList.remove('bg-white/5', 'text-text-muted');
                countdownDisplay.classList.add('bg-primary-500/20', 'text-primary-400');
            } else {
                countdownDisplay.textContent = 'Off';
                countdownDisplay.classList.remove('bg-primary-500/20', 'text-primary-400');
                countdownDisplay.classList.add('bg-white/5', 'text-text-muted');
            }
        }

        toggle.onchange = function () { localStorage.setItem('episodes-refresh-enabled', toggle.checked); startTimer(); };
        intervalInput.onchange = function () {
            let val = parseInt(this.value);
            if (isNaN(val) || val < 5) { val = 5; this.value = 5; }
            if (val > 300) { val = 300; this.value = 300; }
            localStorage.setItem('episodes-refresh-interval', val);
            startTimer();
        };
        startTimer();
    })();
    {% endif %}
    // View Toggle Logic for Episodes
    document.addEventListener('DOMContentLoaded', () => {
        function setEpisodeView(mode) {
            const grid = document.getElementById('episodes-grid');
            if (!grid) return;

            // Set attribute
            grid.setAttribute('data-view', mode);

            // Save preference
            try {
                localStorage.setItem('episodes-view-mode', mode);
            } catch (e) {
                console.warn('Could not save view preference', e);
            }

            // Update buttons
            ['grid', 'list'].forEach(m => {
                const btn = document.getElementById(`view-${m}`);
                if (btn) {
                    if (m === mode) {
                        btn.classList.add('bg-primary-500', 'text-white');
                        btn.classList.remove('text-text-muted', 'hover:bg-white/[0.1]');
                    } else {
                        btn.classList.remove('bg-primary-500', 'text-white');
                        btn.classList.add('text-text-muted', 'hover:bg-white/[0.1]');
                    }
                }
            });
        }

        // Init view
        const savedView = localStorage.getItem('episodes-view-mode') || 'grid';
        setEpisodeView(savedView);

        // Attach listeners
        ['grid', 'list'].forEach(m => {
            const btn = document.getElementById(`view-${m}`);
            if (btn) {
                btn.addEventListener('click', () => setEpisodeView(m));
            }
        });
    });
</script>
{% endblock %}