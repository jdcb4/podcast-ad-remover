{% extends "admin/layout.html" %}

{% block admin_content %}
{% macro shuttle_ui(provider, label, input_name, initial_value) %}
<div class="bg-surface-base p-4 rounded-xl border border-white/[0.08] mt-4">
    <div class="flex justify-between items-center mb-4">
        <div>
            <label class="block text-sm font-medium">{{ label }}</label>
            <span class="text-xs text-text-muted">Drag to reorder. Max 5 models.</span>
        </div>
        <div class="space-x-2">
            <button type="button" onclick="shuttleManager.refresh('{{ provider }}')"
                class="text-xs bg-primary-500/20 text-primary-400 px-2 py-1 rounded hover:bg-primary-500/30">Refresh</button>
            <button type="button" onclick="shuttleManager.reset('{{ provider }}')"
                class="text-xs bg-white/5 text-text-secondary px-2 py-1 rounded hover:bg-white/10">Reset</button>
        </div>
    </div>
    <div class="grid grid-cols-[1fr,auto,1fr] gap-2 items-center h-96">
        <div class="flex flex-col h-full overflow-hidden">
            <h5 class="text-xs font-semibold text-text-muted mb-1">Available Models</h5>
            <input type="text" placeholder="Filter..."
                onkeyup="shuttleManager.filterAvailable('{{ provider }}', this.value)" class="input text-xs p-2 mb-1">
            <div class="flex-1 bg-surface-elevated border border-white/[0.06] rounded-lg overflow-y-auto p-2 space-y-1 scrollbar-dark"
                id="{{ provider }}_available"></div>
        </div>
        <div class="flex flex-col gap-2">
            <span class="text-text-muted">&rarr;</span>
        </div>
        <div class="flex flex-col h-full overflow-hidden">
            <h5 class="text-xs font-semibold text-text-muted mb-1">Selected Cascade</h5>
            <div class="flex-1 bg-surface-elevated border border-white/[0.06] rounded-lg overflow-y-auto p-2 space-y-1 scrollbar-dark"
                id="{{ provider }}_selected"></div>
        </div>
    </div>
    <input type="hidden" name="{{ input_name }}" id="{{ provider }}_input" value="{{ initial_value }}">
</div>
{% endmacro %}

<h3 class="font-display text-xl font-bold mb-6">AI Configuration</h3>

<form action="/admin/ai/update" method="POST" id="aiForm">
    <div class="space-y-8">
        <!-- Models -->
        <div>
            <h4 class="text-lg font-medium border-b border-white/[0.08] pb-2 mb-4">Core Models</h4>
            <div class="grid grid-cols-1 gap-6">
                <!-- Whisper -->
                <div>
                    <label class="block text-sm font-medium text-text-secondary mb-2">Whisper Model
                        (Transcription)</label>
                    <select name="whisper_model" class="select">
                        {% for model in ['tiny', 'base', 'small', 'medium', 'large'] %}
                        <option value="{{ model }}" {% if settings.whisper_model==model %}selected{% endif %}>
                            {{ model|title }} {% if model == 'base' %}(Default){% endif %}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Piper -->
                <div>
                    <label class="block text-sm font-medium text-text-secondary mb-2">Piper Voice (TTS)</label>
                    <select name="piper_model" class="select">
                        <option value="en_GB-cori-high.onnx" {% if settings.piper_model=='en_GB-cori-high.onnx'
                            %}selected{% endif %}>Cori (High Quality) - UK English</option>
                        <option value="en_US-amy-medium.onnx" {% if settings.piper_model=='en_US-amy-medium.onnx'
                            %}selected{% endif %}>Amy (Medium) - US English</option>
                        <option value="en_US-ryan-medium.onnx" {% if settings.piper_model=='en_US-ryan-medium.onnx'
                            %}selected{% endif %}>Ryan (Medium) - US English</option>
                        <option value="en_US-lessac-medium.onnx" {% if settings.piper_model=='en_US-lessac-medium.onnx'
                            %}selected{% endif %}>Lessac (Medium) - US English</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- AI Provider Selection -->
        <div>
            <h4 class="text-lg font-medium border-b border-white/[0.08] pb-2 mb-4">AI Provider</h4>
            <select name="active_ai_provider" id="providerSelect" class="select mb-4"
                onchange="toggleProviderSettings()">
                <option value="gemini" {% if settings.active_ai_provider=='gemini' %}selected{% endif %}>Google Gemini
                    (Default)</option>
                <option value="openai" {% if settings.active_ai_provider=='openai' %}selected{% endif %}>OpenAI</option>
                <option value="anthropic" {% if settings.active_ai_provider=='anthropic' %}selected{% endif %}>Anthropic
                    (Claude)</option>
                <option value="openrouter" {% if settings.active_ai_provider=='openrouter' %}selected{% endif %}>
                    OpenRouter</option>
            </select>

            <!-- Gemini Shuttle -->
            <div id="geminiSettings" class="provider-section">
                <div>
                    <label class="block text-sm font-medium text-text-secondary mb-2">Gemini API Key</label>
                    <input type="password" name="gemini_api_key" id="gemini_key"
                        value="{{ settings.gemini_api_key or '' }}"
                        placeholder="{% if env_keys.GEMINI_API_KEY %}Using Environment Variable{% else %}Enter API Key{% endif %}"
                        class="input mb-2">
                    {% if env_keys.GEMINI_API_KEY %}
                    <p class="text-xs text-emerald-400 mb-2">✓ Environment Variable Detected (will be used if this field
                        is empty)</p>
                    {% endif %}
                </div>
                {{ shuttle_ui('gemini', 'Gemini Model Cascade', 'ai_model_cascade', settings.ai_model_cascade | tojson)
                }}
            </div>

            <!-- OpenAI Shuttle -->
            <div id="openaiSettings" class="provider-section hidden space-y-4">
                <div>
                    <label class="block text-sm font-medium text-text-secondary mb-2">OpenAI API Key</label>
                    <input type="password" name="openai_api_key" id="openai_key"
                        value="{{ settings.openai_api_key or '' }}"
                        placeholder="{% if env_keys.OPENAI_API_KEY %}Using Environment Variable{% else %}Enter API Key{% endif %}"
                        class="input">
                    {% if env_keys.OPENAI_API_KEY %}
                    <p class="text-xs text-emerald-400">✓ Environment Variable Detected</p>
                    {% endif %}
                </div>
                {{ shuttle_ui('openai', 'OpenAI Model Cascade', 'openai_model', settings.openai_model | tojson) }}
            </div>

            <!-- Anthropic Shuttle -->
            <div id="anthropicSettings" class="provider-section hidden space-y-4">
                <div>
                    <label class="block text-sm font-medium text-text-secondary mb-2">Anthropic API Key</label>
                    <input type="password" name="anthropic_api_key" id="anthropic_key"
                        value="{{ settings.anthropic_api_key or '' }}"
                        placeholder="{% if env_keys.ANTHROPIC_API_KEY %}Using Environment Variable{% else %}Enter API Key{% endif %}"
                        class="input">
                    {% if env_keys.ANTHROPIC_API_KEY %}
                    <p class="text-xs text-emerald-400">✓ Environment Variable Detected</p>
                    {% endif %}
                </div>
                {{ shuttle_ui('anthropic', 'Anthropic Model Cascade', 'anthropic_model', settings.anthropic_model |
                tojson) }}
            </div>

            <!-- OpenRouter Shuttle -->
            <div id="openrouterSettings" class="provider-section hidden space-y-4">
                <div>
                    <label class="block text-sm font-medium text-text-secondary mb-2">OpenRouter API Key</label>
                    <input type="password" name="openrouter_api_key" id="openrouter_key"
                        value="{{ settings.openrouter_api_key or '' }}"
                        placeholder="{% if env_keys.OPENROUTER_API_KEY %}Using Environment Variable{% else %}Enter API Key{% endif %}"
                        class="input">
                    {% if env_keys.OPENROUTER_API_KEY %}
                    <p class="text-xs text-emerald-400">✓ Environment Variable Detected</p>
                    {% endif %}
                </div>
                {{ shuttle_ui('openrouter', 'OpenRouter Model Cascade', 'openrouter_model', settings.openrouter_model |
                tojson) }}
            </div>

            <!-- Test Connection Area -->
            <div class="mt-6 p-4 bg-surface-base rounded-xl border border-white/[0.08]">
                <div class="flex justify-between items-center mb-2">
                    <h4 class="font-medium">Test Configuration</h4>
                    <button type="button" onclick="testConnection()" class="btn-primary btn-sm">Test Connection</button>
                </div>
                <div id="testOutput"
                    class="hidden mt-2 p-2 text-xs font-mono bg-surface-elevated border border-white/[0.06] rounded-lg h-20 overflow-y-auto">
                </div>
            </div>
        </div>

        <div class="flex justify-end pt-4 border-t border-white/[0.08]">
            <button type="submit" class="btn-primary">Save Configuration</button>
        </div>
    </div>
</form>

<!-- SortableJS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

<script nonce="{{ csp_nonce }}">
    const DEFAULTS = {
        'gemini': ['gemini-2.5-flash', 'gemini-2.5-pro', 'gemini-2.5-flash-lite', 'gemini-2.0-flash'],
        'openai': ['gpt-4o', 'gpt-4-turbo', 'gpt-3.5-turbo'],
        'anthropic': ['claude-3-5-sonnet-20241022', 'claude-3-opus-20240229', 'claude-3-haiku-20240307'],
        'openrouter': ['google/gemini-2.0-flash-001', 'meta-llama/llama-3-70b-instruct', 'anthropic/claude-3-opus']
    };

    class ShuttleManager {
        constructor() { this.states = {}; }

        init(provider, initialSelectedJson) {
            let selected = [];
            try {
                if (Array.isArray(initialSelectedJson)) { selected = initialSelectedJson; }
                else if (typeof initialSelectedJson === 'string') {
                    if (initialSelectedJson.startsWith('[')) {
                        selected = JSON.parse(initialSelectedJson);
                        if (!Array.isArray(selected)) selected = [String(selected)];
                    } else if (initialSelectedJson.trim() !== "") { selected = [initialSelectedJson]; }
                }
            } catch (e) { selected = []; }

            const defaults = DEFAULTS[provider] || [];
            const allKnown = [...new Set([...defaults, ...selected])];

            this.states[provider] = { selected, allKnown, available: [], filter: '' };
            this.sync(provider);
            this.initSortable(provider);
        }

        sync(provider) {
            const state = this.states[provider];
            state.available = state.allKnown.filter(m => !state.selected.includes(m));
            let displayAvailable = state.available;
            if (state.filter) {
                displayAvailable = displayAvailable.filter(m => m.toLowerCase().includes(state.filter.toLowerCase()));
            }
            this.render(provider, displayAvailable, state.selected);
            this.updateInput(provider);
        }

        filterAvailable(provider, text) {
            this.states[provider].filter = text;
            this.sync(provider);
        }

        render(provider, availableList, selectedList) {
            const availEl = document.getElementById(`${provider}_available`);
            const selEl = document.getElementById(`${provider}_selected`);

            availEl.innerHTML = '';
            availableList.forEach(m => {
                const div = document.createElement('div');
                div.className = 'text-xs p-2 rounded-lg cursor-pointer hover:bg-primary-500/10 bg-surface-base border border-white/[0.06] flex justify-between items-center group';
                div.onclick = () => this.add(provider, m);
                div.innerHTML = `<span>${m}</span><span class="text-primary-400 font-bold opacity-0 group-hover:opacity-100">+</span>`;
                availEl.appendChild(div);
            });

            selEl.innerHTML = '';
            selectedList.forEach(m => {
                const div = document.createElement('div');
                div.className = 'text-xs p-2 rounded-lg cursor-move bg-primary-500/10 border border-primary-500/20 flex justify-between items-center';
                div.innerHTML = `
                    <div class="flex items-center gap-2"><span class="text-text-muted">⋮⋮</span><span>${m}</span></div>
                    <button type="button" onclick="shuttleManager.remove('${provider}', '${m}')" class="text-red-400/50 hover:text-red-400 font-bold">×</button>
                `;
                selEl.appendChild(div);
            });
        }

        add(provider, model) {
            const state = this.states[provider];
            if (state.selected.length >= 5) { alert("Max 5 models."); return; }
            state.selected.push(model);
            this.sync(provider);
        }

        remove(provider, model) {
            const state = this.states[provider];
            state.selected = state.selected.filter(m => m !== model);
            this.sync(provider);
        }

        updateInput(provider) {
            document.getElementById(`${provider}_input`).value = JSON.stringify(this.states[provider].selected);
        }

        initSortable(provider) {
            const el = document.getElementById(`${provider}_selected`);
            new Sortable(el, {
                animation: 150,
                ghostClass: 'bg-primary-500/20',
                onEnd: (evt) => {
                    const state = this.states[provider];
                    const item = state.selected.splice(evt.oldIndex, 1)[0];
                    state.selected.splice(evt.newIndex, 0, item);
                    this.updateInput(provider);
                }
            });
        }

        async refresh(provider) {
            try {
                const res = await fetch(`/admin/ai/refresh/${provider}`);
                const data = await res.json();
                if (data.models) {
                    const state = this.states[provider];
                    data.models.forEach(m => { if (!state.allKnown.includes(m)) state.allKnown.push(m); });
                    this.sync(provider);
                    alert(`Refreshed ${provider}. Found ${data.models.length} models.`);
                } else { alert('Error: ' + data.error); }
            } catch (e) { alert(e); }
        }

        reset(provider) {
            const defs = DEFAULTS[provider];
            if (defs) {
                if (!confirm(`Reset ${provider} model list to system defaults?\n\nDefaults: ${defs.join(', ')}`)) return;
                this.states[provider].selected = [...defs];
                defs.forEach(m => { if (!this.states[provider].allKnown.includes(m)) this.states[provider].allKnown.push(m); });
                this.sync(provider);
            }
        }
    }

    const shuttleManager = new ShuttleManager();

    function toggleProviderSettings() {
        const val = document.getElementById('providerSelect').value;
        document.querySelectorAll('.provider-section').forEach(el => el.classList.add('hidden'));
        const active = document.getElementById(val + 'Settings');
        if (active) active.classList.remove('hidden');
    }
    toggleProviderSettings();

    shuttleManager.init('gemini', {{ settings.ai_model_cascade | tojson }});
    shuttleManager.init('openai', {{ settings.openai_model | tojson }});
    shuttleManager.init('anthropic', {{ settings.anthropic_model | tojson }});
    shuttleManager.init('openrouter', {{ settings.openrouter_model | tojson }});

    async function testConnection() {
        const provider = document.getElementById('providerSelect').value;
        const out = document.getElementById('testOutput');
        out.classList.remove('hidden');
        out.textContent = "Testing...";
        out.className = "mt-2 p-2 text-xs font-mono bg-surface-elevated border border-white/[0.06] rounded-lg h-20 overflow-y-auto";

        const formData = new FormData();
        formData.append('provider', provider);
        const keyEl = document.getElementById(provider + '_key');
        if (keyEl) formData.append('api_key', keyEl.value);
        const modelEl = document.getElementById(provider + '_input');
        if (modelEl) formData.append('model', modelEl.value);

        try {
            const res = await fetch('/admin/ai/test', { method: 'POST', body: formData });
            const data = await res.json();
            if (data.status === 'ok') {
                out.className = "mt-2 p-2 text-xs font-mono bg-emerald-500/10 border border-emerald-500/20 rounded-lg h-20 overflow-y-auto text-emerald-400";
                out.textContent = `SUCCESS: ${data.response}`;
            } else {
                out.className = "mt-2 p-2 text-xs font-mono bg-red-500/10 border border-red-500/20 rounded-lg h-20 overflow-y-auto text-red-400";
                out.textContent = `ERROR: ${data.error}`;
            }
        } catch (e) { out.textContent = "Fail: " + e; }
    }
</script>
{% endblock %}