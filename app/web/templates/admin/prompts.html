{% extends "admin/layout.html" %}

{% block admin_content %}
<h3 class="font-display text-xl font-bold mb-6">AI Prompt Rules</h3>

<div id="alert-container"></div>

<form id="prompts-form" class="space-y-6">
    <!-- Base Prompt -->
    <div>
        <label class="block text-sm font-medium text-text-secondary mb-2">
            Ad Detection Base Prompt
            <span class="text-xs text-text-muted">(Required variables: <code class="text-primary-400">{targets}</code>,
                <code class="text-primary-400">{custom_instr}</code>)</span>
        </label>
        <textarea name="ad_prompt_base" id="ad_prompt_base"
            class="input font-mono text-sm h-40">{{ settings.ad_prompt_base or default_prompts.ad_base }}</textarea>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Targets -->
        <div>
            <label class="block text-sm font-medium text-text-secondary mb-2">Target: Sponsors/Ads</label>
            <textarea name="ad_target_sponsor" id="ad_target_sponsor"
                class="input font-mono text-sm h-24">{{ settings.ad_target_sponsor or default_prompts.sponsor }}</textarea>
        </div>
        <div>
            <label class="block text-sm font-medium text-text-secondary mb-2">Target: Promos</label>
            <textarea name="ad_target_promo" id="ad_target_promo"
                class="input font-mono text-sm h-24">{{ settings.ad_target_promo or default_prompts.promo }}</textarea>
        </div>
    </div>

    <!-- Summary Prompt -->
    <div>
        <label class="block text-sm font-medium text-text-secondary mb-2">
            Summary Generation Template
            <span class="text-xs text-text-muted">(Required variable: <code
                    class="text-primary-400">{transcript_context}</code>. Optional: <code
                    class="text-primary-400">{targets}</code>)</span>
        </label>
        <textarea name="summary_prompt_template" id="summary_prompt_template"
            class="input font-mono text-sm h-40">{{ settings.summary_prompt_template or default_prompts.summary }}</textarea>
    </div>

    <div class="flex gap-3">
        <button type="submit" id="save-btn" class="btn-primary">Save Changes</button>
        <button type="button" id="reset-btn" class="btn-secondary">Reset to Defaults</button>
    </div>
</form>

<script nonce="{{ csp_nonce }}">
    const form = document.getElementById('prompts-form');
    const saveBtn = document.getElementById('save-btn');
    const resetBtn = document.getElementById('reset-btn');
    const alertContainer = document.getElementById('alert-container');

    const requiredVars = {
        'ad_prompt_base': ['{targets}', '{custom_instr}'],
        'summary_prompt_template': ['{transcript_context}']
    };

    function showAlert(message, type = 'error') {
        const alertClass = type === 'success' ? 'alert-success' : 'alert-error';
        alertContainer.innerHTML = `<div class="${alertClass} mb-4">${message}</div>`;
        setTimeout(() => alertContainer.innerHTML = '', 5000);
    }

    function validatePrompts(formData) {
        for (const [field, vars] of Object.entries(requiredVars)) {
            const value = formData.get(field);
            if (!value) continue;
            for (const variable of vars) {
                if (!value.includes(variable)) {
                    return `Error: "${field}" must include the variable ${variable}`;
                }
            }
        }
        return null;
    }

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(form);
        const error = validatePrompts(formData);
        if (error) { showAlert(error, 'error'); return; }

        saveBtn.disabled = true;
        saveBtn.textContent = 'Saving...';

        try {
            const response = await fetch('/admin/prompts', { method: 'POST', body: formData });
            if (response.ok) {
                showAlert('Prompts saved successfully!', 'success');
            } else {
                const data = await response.json();
                showAlert(data.detail || 'Failed to save prompts', 'error');
            }
        } catch (error) {
            showAlert('Network error: ' + error.message, 'error');
        } finally {
            saveBtn.disabled = false;
            saveBtn.textContent = 'Save Changes';
        }
    });

    resetBtn.addEventListener('click', async () => {
        if (!confirm('Reset all prompts to defaults? This cannot be undone.')) return;
        resetBtn.disabled = true;
        resetBtn.textContent = 'Resetting...';

        try {
            const response = await fetch('/admin/prompts/reset', { method: 'POST' });
            if (response.ok) {
                showAlert('Prompts reset to defaults!', 'success');
                setTimeout(() => window.location.reload(), 1000);
            } else {
                showAlert('Failed to reset prompts', 'error');
            }
        } catch (error) {
            showAlert('Network error: ' + error.message, 'error');
        } finally {
            resetBtn.disabled = false;
            resetBtn.textContent = 'Reset to Defaults';
        }
    });
</script>
{% endblock %}